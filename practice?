import pandas as pd
from typing import List, Optional 

def load_data(returns_file: str, boxes_file: str):
    returns = pd.read_csv(returns_file)
    boxes = pd.read_csv(boxes_file)

    returns['volume'] = returns['l'] * returns['w'] * returns['h']
    return returns, boxes

class Box:
    def __init__(self, length: float, width: float, height: float):
        self.length = length
        self.width = width
        self.height = height

    def volume(self) -> float:
        """Calculates the volume of the box."""
        return self.length * self.width * self.height

    def ordered_dims(self) -> List[float]:
        """Returns dimensions sorted in descending order."""
        return sorted([self.length, self.width, self.height], reverse=True)

    def fits_inside(self, other: 'Box') -> bool:
        """Checks whether this box fits inside another box."""
        dims_self = self.ordered_dims()
        dims_other = other.ordered_dims()
        return all(d_self <= d_other for d_self, d_other in zip(dims_self, dims_other))

    def select_box(self, boxes: List['Box']) -> Optional['Box']:
        """Selects the smallest box from a list that this box fits into."""
        feasible = [b for b in boxes if self.fits_inside(b)]
        return min(feasible, key=lambda b: b.volume()) if feasible else None

    def __repr__(self) -> str:
        return f'Box({self.length}, {self.width}, {self.height})'

# Removed: from data_loader import load_data - this was misplaced

def create_box_objects(boxes_df):
    box_objects = []
    for _, row in boxes_df.iterrows():
        box_objects.append(Box(row['l'], row['w'], row['h']))
    return box_objects

def assign_boxes(returns_df, box_objects):
    assignments = []
    outliers = []

    for _, item in returns_df.iterrows():
        # Removed the inner duplicated loop and fixed indentation
        item_box = Box(item['l'], item['w'], item['h'])
        best_box = item_box.select_box(box_objects)

        if best_box:
            item_vol = item_box.volume()
            box_vol = best_box.volume()
            void_fill = 1 - item_vol / box_vol
            assignments.append({
                'sku_id': item['sku_id'],
                'box_dims': (best_box.length, best_box.width, best_box.height),
                'void_fill_rate': round(void_fill, 4),
                'quantity': item['quantity']
            })
        else:
            outliers.append({
                'sku_id': item['sku_id'],
                'quantity': item['quantity']
            })

    return pd.DataFrame(assignments), pd.DataFrame(outliers)

def main():
    returns_df, boxes_df = load_data('returns_data.csv', 'current_boxes.csv')
    box_objects = create_box_objects(boxes_df)
    assignments_df, outliers_df = assign_boxes(returns_df, box_objects)

    assignments_df.to_csv('box_assignments.csv', index=False)
    outliers_df.to_csv('outliers.csv', index=False)

if __name__ == "__main__":
    main()

main()

##BOX ASSIGNMENTS
assignments_df = pd.read_csv('box_assignments.csv')
display(assignments_df.head())

##Outliers
outliers_df = pd.read_csv('outliers.csv')
display(outliers_df.head())
