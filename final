# Python module: dataloading.py
"""
This module contains a function for inputting the returns data and current boxes csv.
"""
import pandas as pd
import math
class Box:
    def __init__(self, length, width, height, box_id=None):
        self.l = length
        self.w = width
        self.h = height
        self.box_id = box_id

    def volume(self):
        return self.l * self.w * self.h / 1000000.0  
#check if fits 
    def fits(self, item_l, item_w, item_h):
        box_dims = sorted([self.l, self.w, self.h], reverse=True)
        return item_l <= box_dims[0] and item_w <= box_dims[1] and item_h <= box_dims[2]
    
 # Input data files   
box_data_fn = input("Please enter the path for current_boxes.csv: ")
returns_data_fn = input("Please enter the path for returns_data.csv: ")

try:
    box_df = pd.read_csv(box_data_fn)
    box_records = box_df.to_dict(orient='records') # converts data frame to a list of records
    print(f'Box data contains {len(box_records)} boxes')
    print(box_records)
except FileNotFoundError:
    print(f'Box data file {box_data_fn} does not exist.')
# Read returns data
try:
    returns_df = pd.read_csv(returns_data_fn)
    returns_records = returns_df.to_dict(orient='records') # converts data frame to a list of records
    print(f'Returns data contains {len(returns_records)} items')
except FileNotFoundError:
    print(f'Returns data file {returns_data_fn} does not exist.')

    #module ends
    
df = returns_df.set_index('sku_id')
df_2 = box_df.set_index('box_id')

df.loc[:,'volume']= df.loc[:,'l'] * df.loc[:,'w'] * df.loc[:,'h'] / 1000000

dim_1, dim_2, dim_3 = [],[],[]
for sku_id, row in df.iterrows():
    dims= sorted([row['l'], row['w'], row['h']], reverse=True)
    dim_1.append(dims[0])
    dim_2.append(dims[1])
    dim_3.append(dims[2])
df.loc[:,'dim_1'] = dim_1
df.loc[:,'dim_2'] = dim_2
df.loc[:,'dim_3'] = dim_3

#put box data into Box class
current_boxes = []
for box_id, row in df_2.iterrows():
    current_boxes.append(Box(row['l'], row['w'], row['h'], box_id=box_id))

#make a list to store the outcome of the box 
assigned_boxes =[]
for sku_id, row in df.iterrows():
    found_box = False
    for box in current_boxes:
        if box.fits(row['dim_1'], row['dim_2'], row['dim_3']):
            found_box = True
            assigned_boxes.append(box.box_id) 
            break            
    if not found_box:
        assigned_boxes.append(None)
df.loc[:,'box'] = assigned_boxes

#generate a new column of box volume in df_2
df_2.loc[:,'box_volume'] = df_2.loc[:,'l']* df_2.loc[:,'w']*df_2.loc[:,'h']/1000000

#generate a new column of box surface area in df_2
df_2.loc[:,'box_surface_area'] = 2 * (df_2.loc[:,'l']*df_2.loc[:,'w'] + df_2.loc[:,'l']*df_2.loc[:,'h'] + df_2.loc[:,'w']*df_2.loc[:,'h'])

#put the box volume in df
box_volume =[]
box_surface_area = []
for sku_id, row in df.iterrows():
        if pd.isna(row['box']):
            box_volume.append(None)
            box_surface_area.append(None)
        else:
            box_volume.append(df_2.loc[row['box'],'box_volume'])
            box_surface_area.append(df_2.loc[row['box'],'box_surface_area'])
df.loc[:,'box volume'] = box_volume
df.loc[:,'box surface area'] = box_surface_area

#calculate void fill volume
void_fill_volume = (df.loc[:,'box volume'] - df.loc[:,'volume'])
df.loc[:,'void fill volume'] = void_fill_volume

#calculate void fill rate 
void_fill_rate = []
void_fill_rate = (df.loc[:,'box volume'] - df.loc[:,'volume'])/df.loc[:,'box volume']
df.loc[:,'void fill rate'] =void_fill_rate

# Display the KPI columns
print("\n Calculated KPIs:") 
display(df[['box volume', 'box surface area', 'void fill volume', 'void fill rate']].head())

#current info dashboard to check the current data 
summary_df = df.describe() 

#calculate outlier rate 
outlier_sku = []
outlier_quan = []
for sku_id, row in df.iterrows():
    if pd.isna(row['box']):
        outlier_sku.append(sku_id)
        outlier_quan.append(row['quantity'])
outlier_df = pd.DataFrame({'sku_id':outlier_sku, 'quantity':outlier_quan})
outlier_rate = sum(outlier_quan) / sum(df.loc[:,'quantity'])
print (f'current outlier rate is: {outlier_rate}')

#calculate weighted average void fill rate 
is_packed = pd.notna(df['box'])
fitted_quantity = df.loc[is_packed, 'quantity'].sum()
weighted_avr_void_rate_df = df.loc[:,'quantity'] * df.loc[:,'void fill rate'] /fitted_quantity
weighted_avr_void_rate = weighted_avr_void_rate_df.sum(numeric_only = True)
print (f'current weighted average void fill rate is: {weighted_avr_void_rate}')


# Python module: new rang of box
#design new range of box 
#make a 3 side quantile df as new box and use int 
quantiles = [0.19, 0.38, 0.57, 0.76, 0.95]
new_box_objects = [] 
for i, q in enumerate(quantiles): 
    l_new = math.ceil(df['dim_1'].quantile(q))
    w_new = math.ceil(df['dim_2'].quantile(q))
    h_new = math.ceil(df['dim_3'].quantile(q))
    new_box_objects.append(Box(l_new, w_new, h_new))
max_l = math.ceil(df['dim_1'].max())
max_w = math.ceil(df['dim_2'].max())
max_h = math.ceil(df['dim_3'].max())
new_box_objects.append(Box(max_l,max_w, max_h))
new_boxes_data = []
for b in new_box_objects:
    new_boxes_data.append({'l': b.l, 'w': b.w, 'h': b.h, 'box_volume': b.volume()}) 
new_boxes_df = pd.DataFrame(new_boxes_data)

#module ends

#check new weight avr void fill rate and outlier rate 
new_assigned_boxes =[]
for sku_id, row in df.iterrows():
    """found_box and the indentation make it iterate all box and then put'None' if cannot 
find box that match"""
    found_box = False
    for i, box in enumerate(new_box_objects):
        if box.fits(row['dim_1'], row['dim_2'], row['dim_3']):
            found_box = True
            new_assigned_boxes.append(i)
            break           
    if not found_box:
        new_assigned_boxes.append(None)
df.loc[:,'new assigned box'] = new_assigned_boxes

new_box_volume =[]
for sku_id, row in df.iterrows():
    if pd.isna(row['new assigned box']):
        new_box_volume.append(None)
    else:
        new_box_volume.append(new_boxes_df.loc[row['new assigned box'],'box_volume'])
df.loc[:,'new box volume'] = new_box_volume

#calculate new void fill rate 
new_void_fill_rate = []
new_void_fill_rate = (df.loc[:,'new box volume'] - df.loc[:,'volume'])/df.loc[:,'new box volume']
df.loc[:,'new void fill rate'] = new_void_fill_rate

new_outlier_sku = []
new_outlier_quan = []
for sku_id, row in df.iterrows():
    if pd.isna(row['new assigned box']):
        new_outlier_sku.append(sku_id)
        new_outlier_quan.append(row['quantity'])
new_outlier_df = pd.DataFrame({'sku_id': new_outlier_sku, 'quantity': new_outlier_quan})
new_outlier_rate = sum(new_outlier_quan) / sum(df.loc[:, 'quantity'])
print (f'new outlier rate is: {new_outlier_rate }')

is_packed = pd.notna(df['new assigned box'])
new_fitted_quantity = df.loc[is_packed, 'quantity'].sum()
new_weighted_avr_void_rate_df = df.loc[:, 'quantity'] * df.loc[:, 'new void fill rate'] / new_fitted_quantity
new_weighted_avr_void_rate = new_weighted_avr_void_rate_df.sum(numeric_only=True)
print (f'new weighted avrerge void fill rate is: {new_weighted_avr_void_rate }')

#new info dashboard to check the current data 
summary_df_2 = df.describe() 
